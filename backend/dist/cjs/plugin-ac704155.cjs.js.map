{"version":3,"file":"plugin-ac704155.cjs.js","sources":["../../src/service/router.ts","../../src/plugin.ts"],"sourcesContent":["import { errorHandler /*, loadBackendConfig*/ } from '@backstage/backend-common';\n//import { useApi, configApiRef, identityApiRef } from '@backstage/core-plugin-api';\nimport express from 'express';\nimport Router from 'express-promise-router';\n//import { Logger } from 'winston';\nimport { LoggerService } from '@backstage/backend-plugin-api';\nimport { Config } from '@backstage/config';\n\nexport interface RouterOptions {\n  logger: LoggerService;\n  config: Config;\n}\n\nconst key = 'progressiveDelivery.saasPromotionsJson';\n\nexport async function createRouter(\n  options: RouterOptions,\n): Promise<express.Router> {\n  const { logger, config } = options;\n\n  const router = Router();\n  router.use(express.json());\n\n  router.get('/health', (_, response) => {\n    console.log(\"Health\");\n    logger.info('PONG!');\n    response.json({ status: 'ok' });\n  });\n  router.get('/topo', (_, response) => {\n      console.log(\"SMR KEYS 1\", config.keys());\n      console.log(\"SMR KEYS 2\", config.get('progressiveDelivery'));\n      console.log(\"SMR KEYS 3\", config.get(key));\n\n      response.sendFile(config.getString(key));\n    // loadBackendConfig({logger: logger, argv: []})\n    //   .then((config) => {\n    //     const key = 'progressive-delivery.saas-promotions-json';\n    //\n    //     console.log(\"SMR KEYS 1\", config.keys());\n    //     console.log(\"SMR KEYS 2\", config.get('progressive-delivery'));\n    //     console.log(\"SMR KEYS 3\", config.get(key));\n    //\n    //     response.sendFile(config.getString(key));\n    // }).catch((error) => {\n    //     console.log(\"No config\");\n    //     console.log(error);\n    //     response.sendStatus(500);\n    //   });\n  })\n  router.use(errorHandler());\n  return router;\n}\n","//import { loggerToWinstonLogger } from '@backstage/backend-common';\nimport { coreServices, createBackendPlugin } from '@backstage/backend-plugin-api';\n\nimport { createRouter } from './service/router';\n\n/**\n * The progressive-delivery backend plugin.\n *\n * @public\n */\nexport const progressive_deliveryPlugin = createBackendPlugin({\n  pluginId: 'plugin-progressive-delivery-backend',\n  register(env) {\n    env.registerInit({\n      deps: {\n        httpRouter: coreServices.httpRouter,\n        logger: coreServices.logger,\n        config: coreServices.rootConfig\n      },\n      async init({\n        httpRouter,\n        logger,\n        config,\n      }) {\n        console.log(\"SMR 0: \", config.keys());\n        httpRouter.use(\n          await createRouter({\n            logger,\n            config,\n          }),\n        );\n        httpRouter.addAuthPolicy({\n          path: '/health',\n          allow: 'unauthenticated',\n        });\n        httpRouter.addAuthPolicy({\n          path: '/topo',\n          allow: 'unauthenticated',\n        });\n      },\n    });\n  },\n});\n"],"names":["Router","express","errorHandler","createBackendPlugin","coreServices"],"mappings":";;;;;;;;;;;;AAaA,MAAM,GAAM,GAAA,wCAAA,CAAA;AAEZ,eAAsB,aACpB,OACyB,EAAA;AACzB,EAAM,MAAA,EAAE,MAAQ,EAAA,MAAA,EAAW,GAAA,OAAA,CAAA;AAE3B,EAAA,MAAM,SAASA,0BAAO,EAAA,CAAA;AACtB,EAAO,MAAA,CAAA,GAAA,CAAIC,2BAAQ,CAAA,IAAA,EAAM,CAAA,CAAA;AAEzB,EAAA,MAAA,CAAO,GAAI,CAAA,SAAA,EAAW,CAAC,CAAA,EAAG,QAAa,KAAA;AACrC,IAAA,OAAA,CAAQ,IAAI,QAAQ,CAAA,CAAA;AACpB,IAAA,MAAA,CAAO,KAAK,OAAO,CAAA,CAAA;AACnB,IAAA,QAAA,CAAS,IAAK,CAAA,EAAE,MAAQ,EAAA,IAAA,EAAM,CAAA,CAAA;AAAA,GAC/B,CAAA,CAAA;AACD,EAAA,MAAA,CAAO,GAAI,CAAA,OAAA,EAAS,CAAC,CAAA,EAAG,QAAa,KAAA;AACjC,IAAA,OAAA,CAAQ,GAAI,CAAA,YAAA,EAAc,MAAO,CAAA,IAAA,EAAM,CAAA,CAAA;AACvC,IAAA,OAAA,CAAQ,GAAI,CAAA,YAAA,EAAc,MAAO,CAAA,GAAA,CAAI,qBAAqB,CAAC,CAAA,CAAA;AAC3D,IAAA,OAAA,CAAQ,GAAI,CAAA,YAAA,EAAc,MAAO,CAAA,GAAA,CAAI,GAAG,CAAC,CAAA,CAAA;AAEzC,IAAA,QAAA,CAAS,QAAS,CAAA,MAAA,CAAO,SAAU,CAAA,GAAG,CAAC,CAAA,CAAA;AAAA,GAe1C,CAAA,CAAA;AACD,EAAO,MAAA,CAAA,GAAA,CAAIC,4BAAc,CAAA,CAAA;AACzB,EAAO,OAAA,MAAA,CAAA;AACT;;ACzCO,MAAM,6BAA6BC,oCAAoB,CAAA;AAAA,EAC5D,QAAU,EAAA,qCAAA;AAAA,EACV,SAAS,GAAK,EAAA;AACZ,IAAA,GAAA,CAAI,YAAa,CAAA;AAAA,MACf,IAAM,EAAA;AAAA,QACJ,YAAYC,6BAAa,CAAA,UAAA;AAAA,QACzB,QAAQA,6BAAa,CAAA,MAAA;AAAA,QACrB,QAAQA,6BAAa,CAAA,UAAA;AAAA,OACvB;AAAA,MACA,MAAM,IAAK,CAAA;AAAA,QACT,UAAA;AAAA,QACA,MAAA;AAAA,QACA,MAAA;AAAA,OACC,EAAA;AACD,QAAA,OAAA,CAAQ,GAAI,CAAA,SAAA,EAAW,MAAO,CAAA,IAAA,EAAM,CAAA,CAAA;AACpC,QAAW,UAAA,CAAA,GAAA;AAAA,UACT,MAAM,YAAa,CAAA;AAAA,YACjB,MAAA;AAAA,YACA,MAAA;AAAA,WACD,CAAA;AAAA,SACH,CAAA;AACA,QAAA,UAAA,CAAW,aAAc,CAAA;AAAA,UACvB,IAAM,EAAA,SAAA;AAAA,UACN,KAAO,EAAA,iBAAA;AAAA,SACR,CAAA,CAAA;AACD,QAAA,UAAA,CAAW,aAAc,CAAA;AAAA,UACvB,IAAM,EAAA,OAAA;AAAA,UACN,KAAO,EAAA,iBAAA;AAAA,SACR,CAAA,CAAA;AAAA,OACH;AAAA,KACD,CAAA,CAAA;AAAA,GACH;AACF,CAAC;;;;;"}